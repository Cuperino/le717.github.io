---
layout: script
title: Blog
---
{% include loading.html %}

<noscript>
  Well, would you look at that? The posts could not be loaded.<br>That's OK, because you can visit the
  <a target="_blank" href="{{ site.wpurl }}">blog directly</a> and read to your heart's content. :smiley:
</noscript>

<div class="blog-posts" style="display: none;"></div>
<p class="end-of-posts">
  Well, would you look at that? That's all the posts that were loaded!<br>If you would like to read more, you can visit the
  <a target="_blank" href="{{ site.wpurl }}">actual blog</a> and read to your heart's content. :smiley:
</p>

<script>
  var posts  = [],
      months = {
        "01": "January",
        "02": "February",
        "03": "March",
        "04": "April",
        "05": "May",
        "06": "June",
        "07": "July",
        "08": "August",
        "09": "September",
        "10": "October",
        "11": "November",
        "12": "December"
      };

  /**
   * @constructor
   * Create a blog post object
   */
  function BlogPost(postDate, postID, postTitle, postURL, postContent) {
    this.postContainer    = '<div class="single-post" id="' + postID + '"></div>';
    this.postContent      = postContent;
    this.postDate         = postDate;
    this.postID           = postID;
    this.postIDDOM        = "#" + postID;
    this.postTitle        = postTitle;
    this.postURL          = postURL;
  }

  /**
   * Create a blog post object
   */
  (function() {
    "use strict";
    // Download a different number of posts on different platforms.
    var toDownload = ($.browser.desktop ? 7 : 4);

    $.ajax({
      dataType: "json",
      url: "//public-api.wordpress.com/rest/v1/sites/triangle717.wordpress.com/posts/?number=" + toDownload + "&callback=?",
      success: function(data) {
        data.posts.forEach(function(postInfo) {
          // Create a unique post ID
          var postID  = "post-{0}".format(postInfo.guid.substring(postInfo.guid.indexOf("?p=") + 3, postInfo.guid.length));

          // Convert publishing date to a nicer format
          var postDateParts = postInfo.date.split("T")[0].split("-");
          // Index 0 = Year
          // Index 1 = Month
          // Index 2 = Day
          var dateFormat    = "{0} {1} {2}".format(postDateParts[2], postDateParts[1], postDateParts[0]).split(" ");
          dateFormat[1]     = "{0},".format(dateFormat[1].replace(dateFormat[1], months[dateFormat[1]]));
          var postDate      = dateFormat.join(" ");

          // Create the post object and store it
          var myPost = new BlogPost(postDate, postID, postInfo.title, postInfo.short_URL, postInfo.content);
          posts.push(myPost);
        });

        // Now that the posts are stored, go through and display them
        // and stop the loading animation
        $(".ani-loading").remove();
        showPosts();
        $(".blog-posts").removeAttr("style");
        $(".end-of-posts").css("display", "block");
      }
    });
  })();

  /**
   *  Display each blog post
   */
  function showPosts() {
    "use strict";
    $.each(posts, function(key, value) {
      value.cleanUp();

      // Add the post container to the page
      $(".blog-posts").append(value.postContainer);

      // Display post details in the following order:
      // Post title/ permalink to WordPress
      // Publish date
      // Post content

      $(value.postIDDOM).append("<a class='post-url' target='_blank'><h1 class='post-title'></h1></a>");
      $(value.postIDDOM).append("<p class='post-meta'><span class='post-date'></span></p>");
      $(value.postIDDOM).append("<div class='post-content' style='display: none;'></div>");

      $(value.postIDDOM + " .post-title").html(value.postTitle);
      $(value.postIDDOM + " .post-date").html(value.postDate);
      $(value.postIDDOM + " .post-url").attr("href", value.postURL);

      // Add the post content
      $(value.postIDDOM + " .post-content").html(value.postContent);

      // Run various cleanup functions
      cleanupPost(value.postIDDOM);
    });
  }


  /**
   * Remove WordPress classes, IDs, and other unnecessary clutter
   * TODO Make this work
   */
  BlogPost.prototype.cleanUp = function() {
   "use strict";
    this.postContent = this.postContent.replace(/(alignnone|alignleft|aligncenter|alignright|wp-caption)/gi, "");
    console.log(this.postContent);
  };


  /**
   * Remove WordPress classes, IDs, and other unnecessary clutter
   */
  function cleanupPost(postContainer) {
    "use strict";
    // TODO Move this into the BlogPost prototype

    $(function() {
      // Center the images that have captions applied
      $(".wp-caption").addClass("text-center");

      // Remove any WordPress image-related classes
      $(postContainer + " .post-content").find("img").each(function() {
        var $this = $(this);
        $this.removeAttr("class");
        $this.removeAttr("style");

        // Center non-captioned images
        $this.parent("p").addClass("text-center");

        // Style and resize images
        $this.addClass("img-shadow");
        $this.addClass("img-responsive");
      });

      // Remove WordPress emote classes
      $(postContainer).find("span").each(function() {
        var $this = $(this);
        $this.removeAttr("class");
        $this.removeAttr("title");
      });

      // Remove any WordPress alignment classes and style attributes
      $(postContainer).find("div").each(function() {
        var $this = $(this);
        // $this.removeClass("alignnone");
        // $this.removeClass("alignleft");
        // $this.removeClass("aligncenter");
        // $this.removeClass("alignright");
        // $this.removeClass("wp-caption");
        $this.removeAttr("id");
        $this.removeAttr("style");
      });

      // Apply alignment for image caption text
      $(postContainer).find("p").each(function() {
        var $this = $(this);
        if ($this.hasClass("wp-caption-text")) {
          $this.removeClass("wp-caption-text");
          $this.css("text-align", "inherit");
        }
      });
   });
  }
</script>
