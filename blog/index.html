---
layout: script
title: Blog
---
{% include loading.html %}
<noscript>
  Well, would you look at that? The posts could not be loaded.<br>That's OK, because you can visit the
  <a target="_blank" href="{{ site.author_wp }}">WordPress.com</a> and read to your heart's content.
</noscript>

<div class="blog-posts" style="display: none;"></div>
<p class="end-of-posts">
  Well, would you look at that? That's all the posts that were loaded!<br>If you would like to read more, you can visit
  <a target="_blank" href="{{ site.author_wp }}">WordPress.com</a> and read to your heart's content!
</p>

<script>
  var posts  = [],
      months = {
        "01": "January",
        "02": "February",
        "03": "March",
        "04": "April",
        "05": "May",
        "06": "June",
        "07": "July",
        "08": "August",
        "09": "September",
        "10": "October",
        "11": "November",
        "12": "December"
      };

  /**
   * @constructor
   * Create a blog post object
   */
  function BlogPost(date, id, title, address, content) {
    this.date      = date;
    this.title     = title;
    this.address   = address;
    this.content   = content;
    this.selector  = "#" + id;
    this.container = '<div class="single-post" id="' + id + '"></div>';
  }

  /**
   * Create a blog post object
   */
  (function() {
    "use strict";
    // Display a different number of posts depending on the platform
    var numOfPosts = ($.browser.desktop ? 7 : 4);

    $.ajax({
      dataType: "json",
      url: "//public-api.wordpress.com/rest/v1/sites/triangle717.wordpress.com/posts/?number=" + numOfPosts + "&callback=?",
      success: function(data) {
        data.posts.forEach(function(postInfo) {
          // Create a unique post ID
          var postID  = "post-{0}".format(postInfo.guid.substr(-4));

          // Convert publishing date to a nicer format
          // Index 0 = Year
          // Index 1 = Month
          // Index 2 = Day
          var postDateParts = postInfo.date.split("T")[0].split("-");
          var dateFormat    = "{0} {1} {2}".format(postDateParts[2], postDateParts[1], postDateParts[0]).split(" ");
          dateFormat[1]     = "{0},".format(dateFormat[1].replace(dateFormat[1], months[dateFormat[1]]));
          var postDate      = dateFormat.join(" ");

          // Create the post object and store it
          var myPost = new BlogPost(postDate, postID, postInfo.title, postInfo.short_URL, postInfo.content);
          posts.push(myPost);
        });

        // Now that the posts are stored, go through and display them
        // and stop the loading animation
        $(".ani-loading").remove();
        showPosts();
        $(".blog-posts").removeAttr("style");
        $(".post-content").removeAttr("style");
        $(".end-of-posts").css("display", "block");
        return true;
      }
    });
  })();

  /**
   *  Display each blog post
   */
  function showPosts() {
    "use strict";
    $.each(posts, function(key, value) {
      // Perform initial cleanup measures
      value.cleanUp();

      // Add the post container to the page
      $(".blog-posts").append(value.container);

      // Display post details in the following order:
      // Post title/permalink to WordPress
      // Publish date
      // Post content
      $(value.selector).append("<a class='post-url' target='_blank'><h1 class='post-title'></h1></a>");
      $(value.selector).append("<p class='post-meta'><span class='post-date'></span></p>");
      $(value.selector).append("<div class='post-content' style='display: none;'></div>");

      $(value.selector + " .post-title").html(value.title);
      $(value.selector + " .post-url").attr("href", value.address);
      $(value.selector + " .post-date").html(value.date);
      $(value.selector + " .post-content").html(value.content);

      // Perform post-DOM addition cleanup
      cleanupPost(value.selector);
      return true;
    });
  }


  /**
   * Remove WordPress classes, IDs, and other unnecessary clutter
   */
  BlogPost.prototype.cleanUp = function() {
   "use strict";
    // Alignment and captions
    this.content = this.content.replace(/alignnone|alignleft|aligncenter|alignright/g, "");
    this.content = this.content.replace(/size-(?:thumbnail|full|medium|large)/g, "");
    this.content = this.content.replace(/wp-caption(?!-text)/g, "text-center");

    // Divs
    this.content = this.content.replace(/div id=".*?"/g, "div");
    this.content = this.content.replace(/div style=".*?"/g, "div");

    // Images
    this.content = this.content.replace(/img class=".*?"/g, "img");
    this.content = this.content.replace(/img style=".*?"/g, "img");

    // Spans (WordPress emotes)
    this.content = this.content.replace(/span class='.*?'/g, "span");
    this.content = this.content.replace(/span title='.*?'/g, "span");

    // Blank attributes
    this.content = this.content.replace(/\sclass="\s?"/g, "");
    this.content = this.content.replace(/\sstyle="\s?"/g, "");
    // console.log(this.content);
    return true;
  };


  /**
   * Remove WordPress classes, IDs, and other unnecessary clutter
   */
  function cleanupPost(postContainer) {
    "use strict";
    // TODO Move this into the BlogPost prototype
    $(function() {
      // Apply alignment for image caption text
      $(postContainer).find("p").each(function() {
        var $this = $(this);
        if ($this.hasClass("wp-caption-text")) {
          $this.removeAttr("class");
          $this.css("text-align", "inherit");
        }
      });
   });
  }
</script>
